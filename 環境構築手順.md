# EZTest 環境構築手順

このドキュメントでは、EZTestの環境構築手順を説明します。

---

## 📋 目次

1. [システム要件](#システム要件)
2. [Dockerを使ったクイックスタート（推奨）](#dockerを使ったクイックスタート推奨)
   - [開発環境のセットアップ](#開発環境のセットアップ)
   - [本番環境のセットアップ](#本番環境のセットアップ)
3. [ローカル開発環境のセットアップ](#ローカル開発環境のセットアップ)
4. [環境変数の設定](#環境変数の設定)
5. [初期設定とデータベースのセットアップ](#初期設定とデータベースのセットアップ)
6. [動作確認](#動作確認)
7. [トラブルシューティング](#トラブルシューティング)

---

## 📊 システム要件

| 項目 | 最小要件 | 推奨要件 | 本番環境 |
|------|---------|---------|---------|
| **CPU** | 1コア | 2コア | 4コア以上 |
| **メモリ** | 2GB | 4GB | 8GB以上 |
| **ストレージ** | 10GB | 20GB | 50GB以上 |
| **データベース** | PostgreSQL 14+ | PostgreSQL 16 | PostgreSQL 16+ |
| **Node.js** | 18.x | 20.x | 20.x LTS |
| **Docker** | Docker Engine 20.10+ | Docker Compose v2.0+ | 最新版 |

---

## 🐳 Dockerを使ったクイックスタート（推奨）

Dockerを使用する方法が最も簡単で推奨されています。

### 前提条件

- Docker Engine 20.10以上がインストールされていること
- Docker Compose v2.0以上がインストールされていること

### 開発環境のセットアップ

開発環境では、ホットリロードが有効で、ソースコードの変更が即座に反映されます。

#### 1. リポジトリのクローン

```bash
git clone https://github.com/houseoffoss/eztest.git
cd eztest
```

#### 2. 環境変数ファイルの作成

```bash
# 開発環境用の環境変数ファイルを作成（必要に応じて編集）
cp .env.example .env
```

#### 3. 開発環境の起動

```bash
# 開発環境を起動（バックグラウンドで実行）
docker-compose -f docker-compose.dev.yml up -d

# ログを確認
docker-compose -f docker-compose.dev.yml logs -f app
```

#### 4. データベースの初期化

```bash
# データベーススキーマの適用
docker-compose -f docker-compose.dev.yml exec app npx prisma db push

# 初期データの投入
docker-compose -f docker-compose.dev.yml exec app npx prisma db seed
```

#### 5. アクセス

ブラウザで以下のURLにアクセス：
- **アプリケーション**: `http://localhost:3000`
- **データベース**: `localhost:5434`

#### 開発環境の停止

```bash
docker-compose -f docker-compose.dev.yml down
```

---

### 本番環境のセットアップ

本番環境では、最適化されたビルドが使用され、パフォーマンスが向上します。

#### 1. リポジトリのクローン

```bash
git clone https://github.com/houseoffoss/eztest.git
cd eztest
```

#### 2. 環境変数ファイルの作成と設定

```bash
# 環境変数ファイルを作成
cp .env.example .env

# 環境変数ファイルを編集（重要：本番環境では必ず変更）
nano .env  # またはお好みのエディタ
```

#### 3. 本番環境用の重要な設定

`.env`ファイルで以下の値を必ず変更してください：

```env
# セキュアなランダム文字列を生成: openssl rand -base64 32
NEXTAUTH_SECRET="your-super-secure-random-string-here"

# ドメインまたはIPアドレスに更新
APP_URL="https://your-domain.com"
NEXTAUTH_URL="https://your-domain.com"

# 強力なデータベースパスワード
DATABASE_URL="postgresql://eztest:YOUR_STRONG_PASSWORD@postgres:5432/eztest?schema=public"
POSTGRES_PASSWORD="YOUR_STRONG_PASSWORD"

# 本番環境モード
NODE_ENV="production"
```

#### 4. 本番環境の起動

```bash
# 本番環境を起動（バックグラウンドで実行）
docker-compose up -d

# ログを確認
docker-compose logs -f

# ステータスを確認
docker-compose ps
```

#### 5. データベースの初期化

```bash
# データベーススキーマの適用
docker-compose exec app npx prisma db push

# 初期データの投入
docker-compose exec app npx prisma db seed
```

#### 6. アクセス

ブラウザで以下のURLにアクセス：
- **ローカル**: `http://localhost:3000`
- **本番環境**: `https://your-domain.com`

#### 本番環境の停止

```bash
docker-compose down
```

---

## 💻 ローカル開発環境のセットアップ

Dockerを使用せずに、ローカル環境で開発する場合の手順です。

### 前提条件

- Node.js 18以上がインストールされていること
- PostgreSQL 16がインストールされていること（またはDockerでPostgreSQLを起動）

### 1. リポジトリのクローン

```bash
git clone https://github.com/houseoffoss/eztest.git
cd eztest
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. 環境変数ファイルの作成

```bash
cp .env.example .env
```

### 4. 環境変数の設定

`.env`ファイルを編集して、データベース接続情報などを設定します：

```env
# ローカルのPostgreSQLを使用する場合
DATABASE_URL="postgresql://eztest:password@localhost:5432/eztest?schema=public"

# または、DockerでPostgreSQLを起動する場合
# docker-compose up -d postgres
# DATABASE_URL="postgresql://eztest:eztest_password@localhost:5433/eztest?schema=public"
```

### 5. PostgreSQLの起動（Dockerを使用する場合）

```bash
# PostgreSQLのみをDockerで起動
docker-compose up -d postgres
```

### 6. データベースのセットアップ

```bash
# Prisma Clientの生成
npx prisma generate

# データベーススキーマの適用
npx prisma db push

# 初期データの投入
npx prisma db seed
```

### 7. 開発サーバーの起動

```bash
npm run dev
```

### 8. アクセス

ブラウザで `http://localhost:3000` にアクセスします。

---

## ⚙️ 環境変数の設定

### 必須設定項目

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `DATABASE_URL` | PostgreSQL接続URL | `postgresql://user:password@host:port/database` |
| `NEXTAUTH_SECRET` | NextAuth.js用のシークレットキー | `openssl rand -base64 32`で生成 |
| `NEXTAUTH_URL` | アプリケーションのベースURL | `http://localhost:3000` |

### オプション設定項目

| 変数名 | 説明 | デフォルト値 |
|--------|------|------------|
| `ADMIN_EMAIL` | 初期管理者のメールアドレス | `admin@eztest.local` |
| `ADMIN_PASSWORD` | 初期管理者のパスワード | `Admin@123456` |
| `ENABLE_ATTACHMENTS` | ファイル添付機能の有効化 | `false` |
| `AWS_ACCESS_KEY_ID` | AWS S3用のアクセスキー（添付ファイル使用時） | - |
| `AWS_SECRET_ACCESS_KEY` | AWS S3用のシークレットキー（添付ファイル使用時） | - |
| `AWS_S3_BUCKET` | S3バケット名（添付ファイル使用時） | - |
| `ENABLE_SMTP` | メール送信機能の有効化 | `false` |
| `SMTP_HOST` | SMTPサーバーのホスト名 | - |
| `SMTP_PORT` | SMTPサーバーのポート | `587` |
| `SMTP_USER` | SMTP認証ユーザー名 | - |
| `SMTP_PASS` | SMTP認証パスワード | - |

詳細は `.env.example` ファイルを参照してください。

---

## 🗄️ 初期設定とデータベースのセットアップ

### デフォルト管理者アカウント

初回起動時に、以下のデフォルト管理者アカウントが作成されます：

- **メールアドレス**: `admin@eztest.local`
- **パスワード**: `Admin@123456`

> 💡 カスタマイズする場合は、`.env`ファイルで`ADMIN_EMAIL`と`ADMIN_PASSWORD`を設定してから、データベースのシードを実行してください。

### データベース操作コマンド

#### データベーススキーマの適用

```bash
# Docker使用時
docker-compose exec app npx prisma db push

# ローカル環境
npx prisma db push
```

#### 初期データの投入

```bash
# Docker使用時
docker-compose exec app npx prisma db seed

# ローカル環境
npm run db:seed
```

#### Prisma Studio（データベースビジュアルエディタ）の起動

```bash
# Docker使用時
docker-compose exec app npx prisma studio

# ローカル環境
npx prisma studio
```

#### データベースのリセット（警告：全データが削除されます）

```bash
# Docker使用時
docker-compose exec app npx prisma migrate reset --force

# ローカル環境
npx prisma migrate reset --force
```

---

## ✅ 動作確認

### 1. サービスが正常に起動しているか確認

```bash
# Docker使用時
docker-compose ps

# すべてのサービスが "Up" 状態であることを確認
```

### 2. ログの確認

```bash
# アプリケーションのログ
docker-compose logs -f app

# データベースのログ
docker-compose logs -f postgres
```

### 3. ブラウザでの確認

1. `http://localhost:3000` にアクセス
2. ログインページが表示されることを確認
3. デフォルト管理者アカウントでログイン
   - メール: `admin@eztest.local`
   - パスワード: `Admin@123456`

### 4. ヘルスチェック

```bash
# ヘルスチェックエンドポイントにアクセス
curl http://localhost:3000/api/health
```

---

## 🔧 トラブルシューティング

### アプリケーションが起動しない

**症状**: コンテナが起動しない、またはすぐに停止する

**確認事項**:
1. ログを確認: `docker-compose logs app`
2. データベースが起動しているか確認: `docker-compose ps postgres`
3. ポートが使用されていないか確認: `netstat -an | grep 3000`
4. メモリ不足の可能性: `docker stats`でリソース使用状況を確認

**解決方法**:
- データベースのヘルスチェックが完了するまで待つ
- ポートが競合している場合は、`.env`で`APP_PORT`を変更
- メモリ不足の場合は、Dockerのメモリ制限を増やす

### データベース接続エラー

**症状**: データベースに接続できない

**確認事項**:
```bash
# PostgreSQLが起動しているか確認
docker-compose ps postgres

# PostgreSQLのログを確認
docker-compose logs postgres

# 接続テスト
docker-compose exec postgres psql -U eztest -d eztest -c "SELECT 1;"
```

**解決方法**:
- `.env`ファイルの`DATABASE_URL`が正しいか確認
- PostgreSQLのパスワードが一致しているか確認
- データベースコンテナが完全に起動するまで待つ（ヘルスチェック完了まで）

### メモリ不足エラー

**症状**: コンテナがメモリ不足で停止する

**確認事項**:
```bash
docker stats
```

**解決方法**:
- Docker Desktopのメモリ制限を増やす（設定 > Resources > Memory）
- `docker-compose.yml`のリソース制限を調整

### ポートが既に使用されている

**症状**: ポート3000や5432が既に使用されている

**解決方法**:
- `.env`ファイルでポートを変更:
  ```env
  APP_PORT=3001
  DB_PORT=5433
  ```

### データベースマイグレーションエラー

**症状**: マイグレーションが失敗する

**解決方法**:
```bash
# データベースをリセット（警告：全データが削除されます）
docker-compose exec app npx prisma migrate reset --force

# 再度スキーマを適用
docker-compose exec app npx prisma db push
docker-compose exec app npx prisma db seed
```

---

## 📚 参考資料

- [README.md](./README.md) - プロジェクトの概要
- [DOCKER.md](./DOCKER.md) - Dockerデプロイメントの詳細ガイド
- [開発者ガイド](./docs/contributing/development-setup.md) - 開発環境の詳細設定
- [アーキテクチャドキュメント](./docs/architecture/README.md) - システム設計の詳細

---

## 🆘 サポート

問題が解決しない場合は、以下をご確認ください：

- [GitHub Issues](https://github.com/houseoffoss/eztest/issues) - 既存のIssueを確認
- [ドキュメント](./docs/README.md) - 詳細なドキュメント
- メンテナーへの連絡:
  - Philip Moses: philip.moses@belsterns.com
  - Kavin: kavin.p@belsterns.com

---

**EZTest** - テスト管理を誰でも簡単に 🚀
